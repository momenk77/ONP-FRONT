<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .button:hover {
            background: #2980b9;
        }

        .button.success {
            background: #27ae60;
        }

        .button.error {
            background: #e74c3c;
        }

        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }

        .user-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
        }

        .user-card.instructor {
            border-left: 4px solid #27ae60;
            background: #e8f5e8;
        }

        .user-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üîç User Debug Tool</h1>
        <p>Debug tool to find and test users in the system</p>
    </div>

    <div class="section">
        <h3>üîê Authentication</h3>
        <input type="text" id="token" placeholder="Enter your auth token" />
        <button class="button" onclick="setToken()">Set Token</button>
        <button class="button" onclick="loadTokenFromStorage()">Load from Storage</button>
        <div id="auth-result" class="result" style="display: none;"></div>
    </div>

    <div class="section">
        <h3>üë• All Users in System</h3>
        <button class="button" onclick="loadAllUsers()">Load All Users</button>
        <button class="button success" onclick="loadInstructors()">Load Instructors Only</button>
        <div id="users-result" class="result" style="display: none;"></div>
        <div id="users-cards"></div>
    </div>

    <div class="section">
        <h3>üîç Search Specific User</h3>
        <input type="text" id="search-name" placeholder="Enter name to search (e.g., ahmed aziz)" />
        <button class="button" onclick="searchUser()">Search User</button>
        <div id="search-result" class="result" style="display: none;"></div>
    </div>

    <div class="section">
        <h3>üì§ Test Message Sending</h3>
        <input type="text" id="test-receiver" placeholder="Receiver ID (use actual ID from above)" />
        <input type="text" id="test-course" placeholder="Course ID" />
        <input type="text" id="test-message" placeholder="Test message" />
        <button class="button" onclick="testSendMessage()">Send Test Message</button>
        <div id="send-result" class="result" style="display: none;"></div>
    </div>

    <script>
        let allUsers = [];

        function showResult(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.textContent = message;
            el.className = `result ${type}`;
        }

        function setToken() {
            const token = document.getElementById('token').value.trim();
            if (token) {
                localStorage.setItem('token', token);
                showResult('auth-result', '‚úÖ Token set successfully', 'success');
            } else {
                showResult('auth-result', '‚ùå Please enter a token', 'error');
            }
        }

        function loadTokenFromStorage() {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('token').value = token;
                showResult('auth-result', '‚úÖ Token loaded from storage', 'success');
            } else {
                showResult('auth-result', '‚ùå No token found in storage', 'error');
            }
        }

        async function loadAllUsers() {
            const token = localStorage.getItem('token');
            if (!token) {
                showResult('users-result', '‚ùå Please set token first', 'error');
                return;
            }

            try {
                showResult('users-result', 'üîÑ Loading users...', 'info');

                const response = await fetch('https://mazengad6-001-site1.rtempurl.com/api/Admin/GetUsers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    allUsers = await response.json();

                    let result = `‚úÖ Found ${allUsers.length} users in system:\n\n`;
                    allUsers.forEach((user, index) => {
                        result += `${index + 1}. ID: ${user.id || user.userId}\n`;
                        result += `   Name: "${user.fullName || user.name || 'N/A'}"\n`;
                        result += `   Username: "${user.userName || 'N/A'}"\n`;
                        result += `   Email: "${user.email || 'N/A'}"\n`;
                        result += `   Roles: ${user.roles ? user.roles.join(', ') : 'None'}\n\n`;
                    });

                    showResult('users-result', result, 'success');
                    displayUserCards(allUsers);
                } else {
                    const errorText = await response.text();
                    showResult('users-result', `‚ùå Failed to load users: ${response.status}\n${errorText}`, 'error');
                }
            } catch (error) {
                showResult('users-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function loadInstructors() {
            await loadAllUsers();
            if (allUsers.length > 0) {
                const instructors = allUsers.filter(u => u.roles && u.roles.includes('Instructor'));

                let result = `‚úÖ Found ${instructors.length} instructors:\n\n`;
                instructors.forEach((user, index) => {
                    result += `${index + 1}. ID: ${user.id || user.userId}\n`;
                    result += `   Name: "${user.fullName || user.name || 'N/A'}"\n`;
                    result += `   Username: "${user.userName || 'N/A'}"\n`;
                    result += `   Email: "${user.email || 'N/A'}"\n\n`;
                });

                if (instructors.length === 0) {
                    result += '‚ö†Ô∏è No users with "Instructor" role found!\n';
                    result += 'This might be why "ahmed aziz" is not found as an instructor.';
                }

                showResult('users-result', result, instructors.length > 0 ? 'success' : 'error');
                displayUserCards(instructors, true);
            }
        }

        function displayUserCards(users, instructorsOnly = false) {
            const container = document.getElementById('users-cards');
            container.innerHTML = '';

            if (users.length === 0) {
                container.innerHTML = '<p>No users to display</p>';
                return;
            }

            users.forEach(user => {
                const isInstructor = user.roles && user.roles.includes('Instructor');
                if (instructorsOnly && !isInstructor) return;

                const card = document.createElement('div');
                card.className = `user-card ${isInstructor ? 'instructor' : ''}`;

                card.innerHTML = `
                    <h4>${user.fullName || user.name || 'Unknown Name'} ${isInstructor ? 'üë®‚Äçüè´' : ''}</h4>
                    <div class="user-info">
                        <div><strong>ID:</strong> ${user.id || user.userId}</div>
                        <div><strong>Username:</strong> ${user.userName || 'N/A'}</div>
                        <div><strong>Email:</strong> ${user.email || 'N/A'}</div>
                        <div><strong>Roles:</strong> ${user.roles ? user.roles.join(', ') : 'None'}</div>
                    </div>
                    <button class="button" onclick="testWithUser('${user.id || user.userId}', '${user.fullName || user.name}')">
                        Test Send Message to This User
                    </button>
                `;

                container.appendChild(card);
            });
        }

        function testWithUser(userId, userName) {
            document.getElementById('test-receiver').value = userId;
            document.getElementById('test-message').value = `Hello ${userName}! This is a test message.`;
            showResult('send-result', `Ready to test with User ID: ${userId} (${userName})`, 'info');
        }

        async function searchUser() {
            const searchName = document.getElementById('search-name').value.trim().toLowerCase();
            if (!searchName) {
                showResult('search-result', '‚ùå Please enter a name to search', 'error');
                return;
            }

            if (allUsers.length === 0) {
                showResult('search-result', '‚ö†Ô∏è Load all users first', 'error');
                return;
            }

            const matches = allUsers.filter(user => {
                const fullName = (user.fullName || '').toLowerCase();
                const userName = (user.userName || '').toLowerCase();
                const name = (user.name || '').toLowerCase();

                return fullName.includes(searchName) ||
                    userName.includes(searchName) ||
                    name.includes(searchName) ||
                    searchName.includes(fullName) ||
                    searchName.includes(userName) ||
                    searchName.includes(name);
            });

            let result = `üîç Search results for "${searchName}":\n\n`;

            if (matches.length > 0) {
                result += `‚úÖ Found ${matches.length} matching users:\n\n`;
                matches.forEach((user, index) => {
                    result += `${index + 1}. ID: ${user.id || user.userId}\n`;
                    result += `   Name: "${user.fullName || user.name}"\n`;
                    result += `   Username: "${user.userName || 'N/A'}"\n`;
                    result += `   Roles: ${user.roles ? user.roles.join(', ') : 'None'}\n\n`;
                });
                showResult('search-result', result, 'success');
                displayUserCards(matches);
            } else {
                result += `‚ùå No users found matching "${searchName}"\n\n`;
                result += `Available names to search:\n`;
                allUsers.slice(0, 10).forEach(user => {
                    result += `- "${user.fullName || user.name}"\n`;
                });
                if (allUsers.length > 10) {
                    result += `... and ${allUsers.length - 10} more users`;
                }
                showResult('search-result', result, 'error');
            }
        }

        async function testSendMessage() {
            const token = localStorage.getItem('token');
            const receiver = document.getElementById('test-receiver').value.trim();
            const course = document.getElementById('test-course').value.trim();
            const message = document.getElementById('test-message').value.trim();

            if (!token) {
                showResult('send-result', '‚ùå Please set token first', 'error');
                return;
            }

            if (!receiver || !course || !message) {
                showResult('send-result', '‚ùå Please fill all fields', 'error');
                return;
            }

            try {
                showResult('send-result', 'üì§ Sending message...', 'info');

                const payload = {
                    receiverId: receiver,
                    courseId: parseInt(course),
                    content: message
                };

                const response = await fetch('https://mazengad6-001-site1.rtempurl.com/api/Chat/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.text();

                if (response.ok) {
                    showResult('send-result', `‚úÖ Message sent successfully!\n\nPayload: ${JSON.stringify(payload, null, 2)}\n\nResponse: ${result}`, 'success');
                } else {
                    showResult('send-result', `‚ùå Failed to send message\n\nStatus: ${response.status}\nPayload: ${JSON.stringify(payload, null, 2)}\n\nError: ${result}`, 'error');
                }
            } catch (error) {
                showResult('send-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Auto-load token on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTokenFromStorage();
        });
    </script>
</body>

</html>