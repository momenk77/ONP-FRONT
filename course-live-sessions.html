<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Review Sessions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="CSS/nav.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }
    </style>
    <style>
        se ssions-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        }

        .session-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }

        .session-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .session-card.upcoming {
            border-left-color: #28a745;
        }

        .session-card.past {
            border-left-color: #6c757d;
            opacity: 0.7;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .session-date {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .session-time {
            color: #666;
            font-size: 0.95rem;
        }

        .session-duration {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .session-notes {
            margin: 15px 0;
            color: #555;
            font-style: italic;
        }

        .session-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            background: #007bff;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .sessions-grid {
                grid-template-columns: 1fr;
            }

            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .session-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div id="nav-placeholder"></div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-video"></i> Live Review Sessions</h1>
            <p id="course-title">Loading course information...</p>
        </div>

        <div class="actions-bar">
            <div>
                <a href="javascript:history.back()" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </a>
            </div>
            <div id="instructor-actions" style="display: none;">
                <button class="btn btn-primary" onclick="showAddSessionModal()">
                    <i class="fas fa-plus"></i> Add New Session
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading sessions...</p>
        </div>

        <div id="sessions-container" style="display: none;">
            <div id="sessions-grid" class="sessions-grid">
                <!-- Sessions will be loaded here -->
            </div>

            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-calendar-times"></i>
                <h3>No Live Sessions Scheduled</h3>
                <p>There are no upcoming review sessions for this course yet.</p>
            </div>
        </div>
    </div>

    <!-- Add/Edit Session Modal -->
    <div id="session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New Session</h3>
                <button class="close" onclick="hideSessionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-alert"></div>
                <form id="session-form">
                    <input type="hidden" id="session-id" />

                    <div class="form-group">
                        <label for="session-date">Date & Time</label>
                        <input type="datetime-local" id="session-date" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label for="session-duration">Duration (minutes)</label>
                        <input type="number" id="session-duration" class="form-control" min="15" max="300" value="60"
                            required />
                    </div>

                    <div class="form-group">
                        <label for="session-zoom">Zoom Meeting Link</label>
                        <input type="url" id="session-zoom" class="form-control" placeholder="https://zoom.us/j/..."
                            required />
                    </div>

                    <div class="form-group">
                        <label for="session-notes">Notes (Optional)</label>
                        <textarea id="session-notes" class="form-control" rows="3"
                            placeholder="e.g., Final exam review, Chapter 5 discussion..."></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="hideSessionModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Session
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        let courseId = null;
        let sessions = [];
        let currentUser = null;
        let isInstructor = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Load navigation
            loadNavigation();

            // Get course ID from URL
            courseId = getCourseIdFromUrl();
            if (!courseId) {
                showError('Course ID not found in URL');
                return;
            }

            // Get user info
            currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Check if user is instructor
            isInstructor = currentUser.roles && currentUser.roles.includes('Instructor');

            // Show instructor actions if applicable
            if (isInstructor) {
                document.getElementById('instructor-actions').style.display = 'block';
            }

            // Load course info and sessions
            await loadCourseInfo();
            await loadSessions();
        });

        // Utility functions
        function getCourseIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('courseId') || urlParams.get('id');
        }

        function getCurrentUser() {
            try {
                return JSON.parse(localStorage.getItem('user'));
            } catch {
                return null;
            }
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function loadNavigation() {
            fetch('navProfile.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('nav-placeholder').innerHTML = html;
                })
                .catch(console.error);
        }

        // Load course information
        async function loadCourseInfo() {
            try {
                const response = await fetch(`https://mazengad6-001-site1.rtempurl.com/api/Course/${courseId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const course = await response.json();
                    document.getElementById('course-title').textContent = course.title || 'Course Live Sessions';
                    document.title = `Live Sessions - ${course.title}`;
                } else {
                    document.getElementById('course-title').textContent = 'Course Live Sessions';
                }
            } catch (error) {
                console.error('Error loading course info:', error);
                document.getElementById('course-title').textContent = 'Course Live Sessions';
            }
        }

        // Load sessions for the course
        async function loadSessions() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('sessions-container').style.display = 'none';

                const response = await fetch(`https://mazengad6-001-site1.rtempurl.com/api/LiveSessions/course/${courseId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    sessions = await response.json();
                    renderSessions();
                } else if (response.status === 404) {
                    sessions = [];
                    renderSessions();
                } else {
                    throw new Error(`Failed to load sessions: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showError('Failed to load sessions. Please try again.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('sessions-container').style.display = 'block';
            }
        }

        // Render sessions
        function renderSessions() {
            const container = document.getElementById('sessions-grid');
            const emptyState = document.getElementById('empty-state');

            if (!sessions || sessions.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Sort sessions by date
            sessions.sort((a, b) => new Date(a.date) - new Date(b.date));

            container.innerHTML = sessions.map(session => {
                const sessionDate = new Date(session.date);
                const now = new Date();
                const isUpcoming = sessionDate > now;
                const isPast = sessionDate < now;

                return `
                    <div class="session-card ${isUpcoming ? 'upcoming' : isPast ? 'past' : ''}">
                        <div class="session-header">
                            <div>
                                <div class="session-date">
                                    <i class="fas fa-calendar"></i>
                                    ${formatDate(sessionDate)}
                                </div>
                                <div class="session-time">
                                    ${formatTime(sessionDate)}
                                </div>
                            </div>
                            <div class="session-duration">
                                <i class="fas fa-clock"></i>
                                ${session.duration} mins
                            </div>
                        </div>

                        ${session.notes ? `<div class="session-notes">
                            <i class="fas fa-sticky-note"></i>
                            ${escapeHtml(session.notes)}
                        </div>` : ''}

                        <div class="session-actions">
                            ${isUpcoming ? `
                                <a href="${session.zoomLink}" target="_blank" class="btn btn-success">
                                    <i class="fas fa-video"></i> Join via Zoom
                                </a>
                            ` : ''}
                            
                            ${isInstructor ? `
                                <button class="btn btn-secondary" onclick="editSession(${session.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger" onclick="deleteSession(${session.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format date and time
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function showAddSessionModal() {
            document.getElementById('modal-title').textContent = 'Add New Session';
            document.getElementById('session-form').reset();
            document.getElementById('session-id').value = '';

            // Set minimum date to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('session-date').min = now.toISOString().slice(0, 16);

            document.getElementById('session-modal').style.display = 'block';
        }

        function hideSessionModal() {
            document.getElementById('session-modal').style.display = 'none';
            document.getElementById('modal-alert').innerHTML = '';
        }

        function editSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            document.getElementById('modal-title').textContent = 'Edit Session';
            document.getElementById('session-id').value = session.id;

            // Format date for datetime-local input
            const date = new Date(session.date);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('session-date').value = date.toISOString().slice(0, 16);

            document.getElementById('session-duration').value = session.duration;
            document.getElementById('session-zoom').value = session.zoomLink;
            document.getElementById('session-notes').value = session.notes || '';

            document.getElementById('session-modal').style.display = 'block';
        }

        // Form submission
        document.getElementById('session-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const sessionId = document.getElementById('session-id').value;
            const isEdit = !!sessionId;

            const sessionData = {
                courseId: parseInt(courseId),
                date: new Date(document.getElementById('session-date').value).toISOString(),
                duration: parseInt(document.getElementById('session-duration').value),
                zoomLink: document.getElementById('session-zoom').value.trim(),
                notes: document.getElementById('session-notes').value.trim()
            };

            try {
                const url = isEdit
                    ? `https://mazengad6-001-site1.rtempurl.com/api/LiveSessions/${sessionId}`
                    : 'https://mazengad6-001-site1.rtempurl.com/api/LiveSessions/add';

                const method = isEdit ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(sessionData)
                });

                if (response.ok) {
                    hideSessionModal();
                    showSuccess(isEdit ? 'Session updated successfully!' : 'Session created successfully!');
                    await loadSessions();
                } else {
                    const error = await response.text();
                    throw new Error(error || `Failed to ${isEdit ? 'update' : 'create'} session`);
                }
            } catch (error) {
                console.error('Error saving session:', error);
                showModalError(error.message);
            }
        });

        // Delete session
        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) {
                return;
            }

            try {
                const response = await fetch(`https://mazengad6-001-site1.rtempurl.com/api/LiveSessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showSuccess('Session deleted successfully!');
                    await loadSessions();
                } else {
                    throw new Error('Failed to delete session');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showError('Failed to delete session. Please try again.');
            }
        }

        // Alert functions
        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'error');
        }

        function showModalError(message) {
            document.getElementById('modal-alert').innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${escapeHtml(message)}
                </div>
            `;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${escapeHtml(message)}
            `;

            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.header').nextSibling);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('session-modal');
            if (event.target === modal) {
                hideSessionModal();
            }
        }
    </script>
</body>

</html>