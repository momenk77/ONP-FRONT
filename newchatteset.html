<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - ONP</title>
    <!-- nav bar  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="chatv2/chat.css" />
    <!-- Ø±ÙˆØ§Ø¨Ø· CSS -->



    <!-- /* Navbar  styles */ -->
    <style>
        .navbar {
            background-color: #111;
            color: white;
            padding: 0.75rem 1.5rem;
        }

        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            direction: ltr;
        }

        .brand a {
            order: 1;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }

        .nav-links {
            order: 2;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-links li a {
            color: white;
            text-decoration: none;
            font-size: 1rem;
        }

        .hamburger {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }

        .has-submenu {
            position: relative;
        }

        .submenu {
            display: none;
            position: absolute;
            background: #222;
            padding: 0.5rem 1rem;
            top: 100%;
            left: 0;
            border-radius: 6px;
            z-index: 1000;
        }

        .has-submenu:hover .submenu {
            display: block;
        }

        .submenu li {
            margin-bottom: 0.5rem;
        }

        .submenu li a {
            color: #ccc;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }

            .nav-links {
                display: none;
                flex-direction: column;
                width: 100%;
                margin-top: 1rem;
            }

            .nav-links.show {
                display: flex;
            }

            .nav-links li {
                width: 100%;
                border-top: 1px solid #333;
                padding: 0.5rem 0;
            }

            .has-submenu .submenu {
                position: static;
                background: none;
                padding: 0;
            }

            .submenu li {
                margin-left: 1rem;
            }
        }
    </style>


</head>

<body>

    <!-- NAV BAR -->

    <div id="nav-placeholder"></div>

    <!-- âœ… Chat Section -->
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>


    <!-- CHAT SECTION -->
    <section class="message-area">
        <div class="container">
            <div class="row">
                <!-- Sidebar (Users List) -->
                <div class="col-md-4">
                    <div class="chatlist">
                        <div class="chat-header">
                            <div class="msg-search">
                                <input type="text" class="form-control" id="userSearch" placeholder="Search users..." />
                            </div>
                        </div>

                        <div class="chat-lists">
                            <div id="userList" class="chat-list">
                                <!-- users will load dynamically -->
                                <p class="text-center text-muted mt-3">Loading users...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Box -->
                <div class="col-md-8">
                    <div class="chatbox" id="chatBox">
                        <div class="msg-head d-flex align-items-center justify-content-between p-3 border-bottom">
                            <div class="d-flex align-items-center">
                                <img id="chatUserImage" src="https://mehedihtml.com/chatbox/assets/img/user.png"
                                    alt="user" class="img-fluid rounded-circle" width="45">
                                <div class="ms-3">
                                    <h5 id="chatUserName" class="mb-0">Select a user</h5>
                                    <small id="chatUserStatus">â€“</small>
                                </div>
                            </div>
                        </div>

                        <div class="msg-body p-3">
                            <ul id="chatMessages"></ul>
                        </div>

                        <div class="send-box p-3 border-top">
                            <div class="input-group">
                                <input type="text" id="messageInput" class="form-control"
                                    placeholder="Write a message..." />
                                <button class="btn btn-primary" id="sendMessageBtn">
                                    <i class="fa fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div> <!-- /col -->
            </div>
        </div>
    </section>

    <!-- char-area -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- âœ… Scripts -->
    <script>
        jQuery(document).ready(function () {

            $(".chat-list a").click(function () {
                $(".chatbox").addClass('showbox');
                return false;
            });

            $(".chat-icon").click(function () {
                $(".chatbox").removeClass('showbox');
            });


        });
    </script>



    <!-- Navbar Scripts -->
    <script>
        function loadCSS(href) {
            return new Promise((resolve, reject) => {
                const link = document.createElement("link");
                link.rel = "stylesheet";
                link.href = href;
                link.onload = () => resolve();
                link.onerror = () => reject(`Failed to load CSS: ${href}`);
                document.head.appendChild(link);
            });
        }

        Promise.all([
            fetch("navProfile.html")
                .then(res => res.text())
                .then(html => {
                    document.getElementById("nav-placeholder").innerHTML = html;
                    const storedUser = localStorage.getItem("user");
                    if (storedUser) {
                        const user = JSON.parse(storedUser);
                        if (user.roles[0] !== "Instructor" && user.roles[0] !== "Admin") {
                            document.getElementById("cart-icon")?.style.setProperty("display", "inline-block");
                            document.getElementById("wishlist-icon")?.style.setProperty("display", "inline-block");
                        }
                    }
                }),
            loadCSS("CSS/nav.css") // ØªØ£ÙƒØ¯ Ø¥Ù† nav.css Ø§ØªØ­Ù…Ù„
        ]).then(() => {
            document.body.classList.remove("hidden-body"); // Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø¨Ø³ Ù†Ø¸Ù‡Ø± Ø§Ù„ØµÙØ­Ø©
        });

        function toggleMenu() {
            document.getElementById("nav-links").classList.toggle("show");
        }


    </script>


    <!-- CHAT Functioinality api -->
    <script>
        /* =========================
           Chat â€” Real API integration
           Updated for real data (no fake messages)
           ========================= */

        (function () {
            const API_BASE = "https://mazengad6-001-site1.rtempurl.com/api/Chat";
            const POLL_INTERVAL_MS = 3000;

            let selectedUserId = null;
            let selectedCourseId = null;

            // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ DOM
            const conversationsList = document.getElementById("userList");   // Ù„Ø³ØªØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª)
            const chatBox = document.getElementById("chat-messages");         // ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            const inputBox = document.getElementById("message-input");        // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            const sendButton = document.getElementById("send-btn");           // Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            const chatUserName = document.getElementById("chatUserName");     // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰

            if (!conversationsList || !chatBox || !inputBox || !sendButton) {
                console.warn("âŒ Missing chat DOM elements.");
                return;
            }

            // ğŸ§± Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ Ø¨ØªØ¬Ù‡Ø² Ø§Ù„Ù€ headers Ù…Ø¹ Ø§Ù„Ù€ token
            function getAuthHeaders() {
                const token = localStorage.getItem("token");
                const headers = { "Content-Type": "application/json" };
                if (token) headers["Authorization"] = `Bearer ${token}`;
                return headers;
            }

            // ğŸ“© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª (Ù„Ø³ØªØ© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù„ÙŠ Ù„ÙŠÙƒ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ø¹Ø§Ù‡Ù…)
            async function loadConversations() {
                conversationsList.innerHTML = "<p style='text-align:center;color:gray;'>Loading conversations...</p>";

                try {
                    const res = await fetch(`${API_BASE}/conversations`, {
                        headers: getAuthHeaders()
                    });

                    if (!res.ok) throw new Error("Failed to load conversations");
                    const convos = await res.json();

                    if (!Array.isArray(convos) || convos.length === 0) {
                        conversationsList.innerHTML = "<p style='text-align:center;color:gray;'>No conversations found.</p>";
                        return;
                    }

                    conversationsList.innerHTML = convos.map(c => `
                <a href="#" class="conversation-item" 
                    data-user="${c.otherUserId}" 
                    data-course="${c.courseId}">
                    <div class="d-flex align-items-center">
                        <img src="${c.otherUserProfileImage || 'https://mehedihtml.com/chatbox/assets/img/user.png'}" 
                             alt="" width="45" height="45" style="border-radius:50%;margin-right:10px;">
                        <div>
                            <h6 style="margin:0;">${c.otherUserName}</h6>
                            <small style="color:gray;">${c.courseTitle}</small><br>
                            <span style="font-size:0.8rem;color:#aaa;">${c.lastMessage || ""}</span>
                        </div>
                    </div>
                </a>
            `).join("");

                    document.querySelectorAll(".conversation-item").forEach(item => {
                        item.addEventListener("click", (e) => {
                            e.preventDefault();
                            selectedUserId = item.dataset.user;
                            selectedCourseId = item.dataset.course;
                            const name = item.querySelector("h6").textContent;
                            openChat(selectedUserId, selectedCourseId, name);
                        });
                    });

                } catch (err) {
                    console.error("âŒ Error loading conversations:", err);
                    conversationsList.innerHTML = "<p style='color:red;text-align:center;'>Error loading conversations</p>";
                }
            }

            // ğŸ’¬ ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ÙŠÙ†Ø© ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            async function openChat(otherUserId, courseId, name) {
                chatUserName.textContent = name;
                chatBox.innerHTML = "<p style='text-align:center;color:gray;'>Loading messages...</p>";

                try {
                    const res = await fetch(`${API_BASE}/messages/${otherUserId}/${courseId}`, {
                        headers: getAuthHeaders()
                    });

                    if (!res.ok) throw new Error("Failed to load messages");
                    const messages = await res.json();
                    renderMessages(messages);

                } catch (err) {
                    console.error("âŒ Error loading messages:", err);
                    chatBox.innerHTML = "<p style='color:red;text-align:center;'>Error loading messages</p>";
                }
            }

            // ğŸ§¾ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¯Ø§Ø®Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            function renderMessages(messages) {
                chatBox.innerHTML = "";

                if (!Array.isArray(messages) || messages.length === 0) {
                    chatBox.innerHTML = "<p style='text-align:center;color:gray;'>No messages yet.</p>";
                    return;
                }

                messages.forEach(m => {
                    const isMine = m.isFromCurrentUser;
                    const li = document.createElement("li");
                    li.className = isMine ? "repaly" : "sender";
                    li.innerHTML = `
                <p>${escapeHtml(m.content)}</p>
                <span class="time">${new Date(m.sentAt).toLocaleTimeString()}</span>
            `;
                    chatBox.appendChild(li);
                });

                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
            async function sendMessage() {
                const text = inputBox.value.trim();
                if (!text || !selectedUserId || !selectedCourseId) return;

                try {
                    const res = await fetch(`${API_BASE}/send-message`, {
                        method: "POST",
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            receiverId: selectedUserId,
                            courseId: Number(selectedCourseId),
                            content: text
                        })
                    });

                    if (!res.ok) throw new Error("Failed to send message");

                    inputBox.value = "";
                    await openChat(selectedUserId, selectedCourseId, chatUserName.textContent);

                } catch (err) {
                    console.error("âŒ Send message error:", err);
                    alert("Failed to send message. Try again.");
                }
            }

            // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
            function startPolling() {
                setInterval(() => {
                    if (selectedUserId && selectedCourseId) {
                        openChat(selectedUserId, selectedCourseId, chatUserName.textContent);
                    }
                }, POLL_INTERVAL_MS);
            }

            // ğŸ§° ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù†Øµ Ø¶Ø¯ Ø§Ù„Ù€ XSS
            function escapeHtml(str = "") {
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // ğŸ“ Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            sendButton.addEventListener("click", sendMessage);
            inputBox.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendMessage();
            });

            // ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°
            loadConversations();
            startPolling();

        })();
    </script>




</body>

</html>